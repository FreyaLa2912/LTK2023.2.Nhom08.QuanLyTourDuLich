<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5">
  <meta name="author" content="AdminKit">
  <meta name="keywords"
    content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="shortcut icon" href="img/icons/icon-48x48.png" />

  <link rel="canonical" href="https://demo-basic.adminkit.io/pages-blank.html" />

  <title>QL Đơn đặt Tour</title>

  <link href="css/app.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="wrapper">
    <nav id="sidebar" class="sidebar js-sidebar">
      <div class="sidebar-content js-simplebar">
          <div class="sidebar-brand">
              <span class="align-middle">BrownDuckTour </br> Nhân viên</span>
          </div>

          <ul class="sidebar-nav">
              

              <li class="sidebar-item ">
                  <a class="sidebar-link" href="indexNhanVien.html">
                      <i class="align-middle" data-feather="list"></i>
                      <span class="align-middle">Tour & Lịch trình</span>
                  </a>
              </li>

  
              <li class="sidebar-header">
                  TÍNH NĂNG QUẢN LÝ 
              </li>

              

              <li class="sidebar-item active">
                  <a class="sidebar-link" href="QLDonDatTourNhanVien.html">
                      <i class="align-middle" data-feather="file-text"></i>
                      <span class="align-middle">Đơn đặt Tour</span>
                  </a>
              </li>

              

              <li class="sidebar-header">
                  TÀI KHOẢN
              </li>

              <li class="sidebar-item">
                  <a class="sidebar-link" href="pages-sign-in.html">
                      <i class="align-middle" data-feather="log-in"></i>
                      <span class="align-middle">Đăng xuất</span>
                  </a>
              </li>

              
          </ul>

          
      </div>
  </nav>

    <div class="main">
      <nav class="navbar navbar-expand navbar-light navbar-bg">
        <a class="sidebar-toggle js-sidebar-toggle">
          <i class="hamburger align-self-center"></i>
        </a>
      </nav>

      <main class="content">
        <div class="container-fluid p-0">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">Quản lý đơn đặt tour - Dành cho nhân viên</h1>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
              data-bs-target="#createDatTourModal">
              Tạo đơn
            </button>
          </div>

          <div class="modal fade" id="createDatTourModal" tabindex="-1" aria-labelledby="createDatTourModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="createDatTourModalLabel">Tạo đơn đặt tour</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="createDatTourForm">
                    <div class="mb-3">
                      <label for="nguoiDung" class="form-label">Người dùng</label>
                      <select class="form-select" id="nguoiDung" name="nguoiDung">
                      </select>
                    </div>
                    <div class="mb-3">
                        <label for="tour" class="form-label">Tour</label> 
                        <select class="form-select" id="tour" name="tour">
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="turn" class="form-label">Turn</label> 
                        <select class="form-select" id="turn" name="turn">
                        </select>
                      </div>
                    <div class="mb-3">
                      <label for="ngayDat" class="form-label">Ngày đặt</label>
                      <input type="date" class="form-control" id="ngayDat" name="ngayDat">
                    </div>
                    <div class="mb-3">
                      <label for="soLuongKhach" class="form-label">Số lượng khách</label>
                      <input type="number" class="form-control" id="soLuongKhach" name="soLuongKhach">
                    </div>
                    <div class="mb-3">
                      <label for="tongTien" class="form-label">Tổng tiền</label>
                      <input type="number" class="form-control" id="tongTien" name="tongTien">
                    </div>
                    <button type="submit" class="btn btn-primary">Tạo đơn</button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Danh sách đơn đặt tour</h5>
                </div>
                <div class="card-body">
                  <table class="table table-striped" id="dattourTable">
                    <thead>
                      <tr>
                        <th>Mã đơn</th>
                        <th>Người dùng</th>
                        <th>Tour</th>
                        <th>Đợt</th>
                        <th>Ngày đặt</th>
                        <th>Số lượng khách</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Thông báo</th>
                        <th>Thao tác</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </main>

      </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    // Hàm load danh sách đơn đặt tour
    function loadDatTours() {
      fetch('http://localhost:8080/api/dattours')
        .then(response => {
          if (!response.ok) {
            throw new Error('Lỗi khi lấy danh sách đơn đặt tour');
          }
          return response.json();
        })
        .then(dattours => {
          const tbody = document.querySelector('#dattourTable tbody');
          tbody.innerHTML = ''; // Xóa nội dung cũ trước khi thêm mới

          dattours.forEach(dattour => {
            const row = document.createElement('tr');
            row.innerHTML = `
                        <td>${dattour.maDatTour}</td>
                        <td>${dattour.nguoiDung.hoTen}</td>
                        <td>${dattour.tour_turn.tour.tenTour}</td>
                        <td>${dattour.tour_turn.id.turn}</td>
                        <td>${dattour.ngayDat}</td>
                        <td>${dattour.soLuongKhach}</td>
                        <td>${dattour.tongTien}</td>
                        <td>${dattour.trangThai}</td>
                        <td>${dattour.thongBao || ''}</td>
                        <td>
                            <a href="#" class="btn btn-success btn-sm confirm-dattour" data-madon="${dattour.maDatTour}">Xác nhận</a>
                            <a href="#" class="btn btn-warning btn-sm cancel-dattour" data-madon="${dattour.maDatTour}">Hủy</a>
                        </td>
                    `;
            tbody.appendChild(row);
          });

          // Thêm sự kiện click cho nút "Xác nhận"
          const confirmButtons = document.querySelectorAll('.confirm-dattour');
          confirmButtons.forEach(button => {
            button.addEventListener('click', () => {
              const maDon = button.dataset.madon;

              // Gọi API để xác nhận đơn đặt tour
              fetch(`http://localhost:8080/api/dattours/${maDon}/confirm`, {
                method: 'PUT'
              })
                .then(response => {
                  if (response.ok) {
                    // Cập nhật trạng thái đơn đặt tour trên giao diện
                    button.closest('tr').querySelector('td:nth-child(8)').textContent = 'Đã xác nhận';
                    button.disabled = true; // Vô hiệu hóa nút "Xác nhận"
                  } else {
                    console.error('Lỗi khi xác nhận đơn đặt tour');
                    alert('Xác nhận đơn đặt tour không thành công!');
                  }
                })
                .catch(error => {
                  console.error('Lỗi khi xác nhận đơn đặt tour:', error);
                  alert('Xác nhận đơn đặt tour không thành công!');
                });
            });
          });

          // Thêm sự kiện click cho nút "Hủy"
          const cancelButtons = document.querySelectorAll('.cancel-dattour');
          cancelButtons.forEach(button => {
            button.addEventListener('click', () => {
              const maDon = button.dataset.madon;

              // Gọi API để hủy đơn đặt tour
              fetch(`http://localhost:8080/api/dattours/${maDon}/cancel`, {
                method: 'PUT'
              })
                .then(response => {
                  if (response.ok) {
                    // Cập nhật trạng thái đơn đặt tour trên giao diện
                    button.closest('tr').querySelector('td:nth-child(8)').textContent = 'Đã hủy';
                    button.disabled = true; // Vô hiệu hóa nút "Hủy"
                  } else {
                    console.error('Lỗi khi hủy đơn đặt tour');
                    alert('Hủy đơn đặt tour không thành công!');
                  }
                })
                .catch(error => {
                  console.error('Lỗi khi hủy đơn đặt tour:', error);
                  alert('Hủy đơn đặt tour không thành công!');
                });
            });
          });
        })
        .catch(error => {
          console.error('Lỗi khi lấy danh sách đơn đặt tour:', error);
          alert('Không thể lấy danh sách đơn đặt tour. Vui lòng thử lại sau!');
        });
    }

    // Gọi hàm loadDatTours() khi trang web được tải
    loadDatTours();


    // Lấy danh sách người dùng từ API
    fetch('http://localhost:8080/api/nguoidungs')
      .then(response => response.json())
      .then(nguoiDungs => {
        const nguoiDungSelect = document.getElementById('nguoiDung');
        nguoiDungs.forEach(nguoiDung => {
          const option = document.createElement('option');
          option.value = nguoiDung.maNguoiDung;
          option.textContent = nguoiDung.hoTen;
          nguoiDungSelect.appendChild(option);
        });
      });

    // Lấy danh sách tour từ API
fetch('http://localhost:8080/api/tours')
  .then(response => response.json())
  .then(tours => {
    const tourSelect = document.getElementById('tour');
    tours.forEach(tour => {
      const option = document.createElement('option');
      option.value = tour.maTour;
      option.textContent = tour.tenTour;
      tourSelect.appendChild(option);
    });
  });

  // Lấy danh sách turn khi người dùng chọn tour
  const tourSelect = document.getElementById('tour');
// Lấy danh sách tour từ API
fetch('http://localhost:8080/api/tours')
  .then(response => response.json())
  .then(tours => {
    
    tours.forEach(tour => {
      const option = document.createElement('option');
      option.value = tour.maTour;
      option.textContent = tour.tenTour;
      tourSelect.appendChild(option);
    });

    // Kích hoạt sự kiện change cho tourSelect sau khi đã load danh sách tour
    tourSelect.dispatchEvent(new Event('change')); 
  });

// Lấy danh sách turn khi người dùng chọn tour
tourSelect.addEventListener('change', () => {
  const maTour = tourSelect.value;
  fetch(`http://localhost:8080/api/tour_turns/tours/${maTour}/turns`) // API lấy danh sách turn của tour
    .then(response => response.json())
    .then(turns => {
      const turnSelect = document.getElementById('turn');
      turnSelect.innerHTML = ''; // Xóa các option cũ
      turns.forEach(turn => {
        const option = document.createElement('option');
        option.value = turn; // Giá trị của option là turn
        option.textContent = turn;
        turnSelect.appendChild(option);
      });
    });
});

    // Xử lý submit form tạo đơn đặt tour
    const createDatTourForm = document.getElementById('createDatTourForm');
createDatTourForm.addEventListener('submit', (event) => {
  event.preventDefault();

  const nguoiDung = document.getElementById('nguoiDung').value;
  const maTour = document.getElementById('tour').value; // Lấy maTour
  const turn = document.getElementById('turn').value; // Lấy turn
  const ngayDat = document.getElementById('ngayDat').value;
  const soLuongKhach = document.getElementById('soLuongKhach').value;
  const tongTien = document.getElementById('tongTien').value;

  const data = {
    maNguoiDung: parseInt(nguoiDung),
    maTour: parseInt(maTour), // Gửi maTour
    turn: parseInt(turn), // Gửi turn
    ngayDat: ngayDat,
    soLuongKhach: parseInt(soLuongKhach),
    tongTien: parseFloat(tongTien)
  };


      // Gọi API để tạo đơn đặt tour
      fetch('http://localhost:8080/api/dattours', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
})
    .then(response => {
        if (response.status === 201) { // Kiểm tra status code 201
            // Đóng modal và làm mới bảng danh sách đơn đặt tour
            $('#createDatTourModal').modal('hide');
            loadDatTours();
        } else {
            // Xử lý lỗi chi tiết hơn
            response.json().then(errorData => {
                console.error('Lỗi khi tạo đơn đặt tour:', errorData);
                alert(`Tạo đơn đặt tour không thành công! \n${errorData.message}`); // Hiển thị thông báo lỗi từ server
            });
        }
    })
    .catch(error => {
        console.error('Lỗi khi tạo đơn đặt tour:', error);
        alert('Tạo đơn đặt tour không thành công!');
    });
});
// Gọi hàm loadDatTours() khi trang web được tải
loadDatTours();
  </script>
</body>

</html>