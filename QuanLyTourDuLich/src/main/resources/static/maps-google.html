<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5" />
  <meta name="author" content="AdminKit" />
  <meta name="keywords"
    content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web" />

  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link rel="shortcut icon" href="img/icons/icon-48x48.png" />
  <link rel="canonical" href="https://demo-basic.adminkit.io/maps-google.html" />

  <title>Bản đồ du lịch</title>
  <link href="css/app.css" rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />
</head>

<body>
  <div class="wrapper">
    <nav id="sidebar" class="sidebar js-sidebar">
      <div class="sidebar-content js-simplebar">
        <div class="sidebar-brand">
          <br class="align-middle">BrownDuckTour
          </br>
          Quản lý</span>
        </div>

        <ul class="sidebar-nav">
          <li class="sidebar-item active">
            <a class="sidebar-link" href="indexAdmin.html">
              <i class="align-middle" data-feather="sliders"></i>
              <span class="align-middle">Thống kê</span>
            </a>
          </li>

          <li class="sidebar-header">
            TÍNH NĂNG QUẢN LÝ
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="QLTour.html">
              <i class="align-middle" data-feather="navigation"></i>
              <span class="align-middle">Tour / Lịch trình</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="maps-google.html">
              <i class="align-middle" data-feather="map"></i>
              <span class="align-middle">Bản đồ</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="QLDiaDiem.html">
              <i class="align-middle" data-feather="map-pin"></i>
              <span class="align-middle">Địa điểm</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="QLDotTour.html">
              <i class="align-middle" data-feather="list"></i>
              <span class="align-middle">Đợt Tour</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="QLDonDatTour.html">
              <i class="align-middle" data-feather="file-text"></i>
              <span class="align-middle">Đơn đặt Tour</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="QLNguoiDung.html">
              <i class="align-middle" data-feather="user"></i>
              <span class="align-middle">Tài khoản người dùng</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="QLHuongDanVien.html">
              <i class="align-middle" data-feather="users"></i>
              <span class="align-middle">Hướng dẫn viên</span>
            </a>
          </li>

          <li class="sidebar-header">
            TÀI KHOẢN
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="index.html">
              <i class="align-middle" data-feather="log-in"></i>
              <span class="align-middle">Đăng xuất</span>
            </a>
          </li>

        </ul>

      </div>
    </nav>

    <div class="main">
      <nav class="navbar navbar-expand navbar-light navbar-bg">
        <a class="sidebar-toggle js-sidebar-toggle">
          <i class="hamburger align-self-center"></i>
        </a>
      </nav>

      <main class="content">
        <div class="container-fluid p-0">
          <div id="viewDiv"></div>
        </div>
      </main>

      <footer class="footer">
	</footer>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script src="https://js.arcgis.com/4.25/"></script>
  <script>
	require([
  "esri/Map",
  "esri/views/MapView",
  "esri/Graphic",
  "esri/layers/GraphicsLayer",
  "esri/geometry/Polyline",
  "esri/symbols/SimpleLineSymbol"
], function(Map, MapView, Graphic, GraphicsLayer, Polyline, SimpleLineSymbol) {

  const map = new Map({
    basemap: "topo-vector"
  });

  const view = new MapView({
    container: "viewDiv",
    map: map,
    center: [106.6993, 10.7772], 
    zoom: 12
  });

  const graphicsLayer = new GraphicsLayer();
  map.add(graphicsLayer);

  fetch('http://localhost:8080/api/tours')
    .then(response => response.json())
    .then(tours => {
      tours.forEach(tour => {
        // Gọi API để lấy danh sách địa điểm của tour
        fetch(`http://localhost:8080/api/tours/${tour.maTour}/lichtrinhtours`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Lỗi khi lấy danh sách lịch trình tour');
            }
            return response.json();
          })
          .then(lichTrinhTours => {
            if (!Array.isArray(lichTrinhTours)) { 
              throw new Error('Dữ liệu lịch trình tour không hợp lệ');
            }

            const path = lichTrinhTours.map(lichTrinh => {
			const diaDiem = lichTrinh.diaDiem;
			if (diaDiem && diaDiem.toaDo) {
				// Parse chuỗi JSON và chuyển đổi sang số
				const coordinates = JSON.parse(diaDiem.toaDo); 
				return [parseFloat(coordinates[0]), parseFloat(coordinates[1])]; 
			} else {
				console.error("Địa điểm hoặc tọa độ không hợp lệ:", lichTrinh);
				return null; 
			}
			}).filter(point => point !== null);

            if (path.length > 1) { 
              const polyline = new Polyline({
                paths: path
              });
              const simpleLineSymbol = new SimpleLineSymbol({
                color: [226, 119, 40], 
                width: 2
              });

              const polylineGraphic = new Graphic({
                geometry: polyline,
                symbol: simpleLineSymbol
              });
              graphicsLayer.add(polylineGraphic);
            }

            lichTrinhTours.forEach(lichTrinh => {
              const diaDiem = lichTrinh.diaDiem;
              if (diaDiem && diaDiem.toaDo) {
                const point = {
                  type: "point",
                  longitude: diaDiem.toaDo.coordinates[0],
                  latitude: diaDiem.toaDo.coordinates[1]
                };
                const markerSymbol = {
                  type: "simple-marker",
                  color: [226, 119, 40],
                  outline: {
                    color: [255, 255, 255], 
                    width: 1
                  }
                };
                const pointGraphic = new Graphic({
                  geometry: point,
                  symbol: markerSymbol
                });
                graphicsLayer.add(pointGraphic);
              }
            });
          })
          .catch(error => {
            console.error("Lỗi khi lấy lịch trình tour:", error);
            // Xử lý lỗi và hiển thị thông báo cho người dùng (nếu cần)
          });
      });
    })
    .catch(error => console.error("Lỗi khi lấy danh sách tour:", error));
});
  </script>
</body>

</html>